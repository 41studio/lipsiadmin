<% content_for :head do %>
<script type="text/javascript" charset="utf-8">
Ext.onReady(function(){
	var items = [
		{	name: 'id' },
		{ name: 'email' },
		{ name: 'active'},
		{ name: 'admin'},
		{ name: 'created_at' }
	]

	var js = new Ext.data.JsonStore({
		url: '<%= formatted_list_backend_accounts_path(:json) %>',                                       
		root: 'accounts',
		id: 'id',                                            
		fields: items
	});
	
	js.on('load', function() {
		var accounts = Ext.data.Record.create(items);

		var selections = new Ext.grid.CheckboxSelectionModel();
		 
		var ds = new Ext.data.Store({
			proxy: new Ext.ux.data.PagingMemoryProxy(js.reader.jsonData),
			reader: js.reader,
			remoteSort: true
		});
		
		ds.setDefaultSort('created_at', 'desc');
		
		var grid = new Ext.grid.GridPanel({
			store: ds,
			viewConfig: { forceFit: true },
			clicksToEdit: 'auto',
			enableColumnHide:false,
			enableColumnMove:false,
			border:false,
			bodyBorder:false,
			cls:'grid',
			title:'All account',
			iconCls:'icon-show-all',
			region:'center',
			sm: selections,
			columns: [
				selections,
				{
					header: "Id", 
					width: 15, 
					sortable: true, 
					dataIndex: 'id'
				},{ 
					header: "Email", 
					width: 120, 
					sortable: true, 
					dataIndex: 'email'
				},{ 
					header: "Active", 
					width: 30,
					align: 'center',
					sortable: true, 
					dataIndex: 'active',
					renderer: Ext.util.Format.boolRenderer
				},{ 
					header: "Admin", 
					width: 30,
					align: 'center',
					sortable: true, 
					dataIndex: 'admin',
					renderer: Ext.util.Format.boolRenderer
				},{
					header: "Created At", 
					width: 120, 
					sortable: true, 
					dataIndex: 'created_at',
					renderer: Ext.util.Format.dateRenderer('m/d/Y')
				}	    
			],
			tbar: [
				{
					id:'add',
					text: 'Add',
					disabled:false,
					cls: 'x-btn-text-icon add',
					handler:add
				},'-',{
					id:'edit',
					text: 'Edit',
					disabled:true,
					cls: 'x-btn-text-icon edit',
					handler:edit
				},'-',{
					id:'remove',
					text:'Delete',
					disabled:true,
					cls:'x-btn-text-icon remove',
					handler:remove
				},'->',
					'Search:', ' ',
					 new Ext.app.SearchField({
						pageSize: Ext.util.pageSize,
						store: ds,
						items: items,
						width: 320
					})
			],
			bbar: new Ext.PagingToolbar({
				pageSize: Ext.util.pageSize,
				store: ds,
				displayInfo: true,
				displayMsg: 'Accounts {0} - {1} of {2}',
				emptyMsg: "No account to display"
			})
		});
		
		selections.on('selectionchange', function(){
			var n = selections.getSelected();
			var btns = grid.getTopToolbar().items.map;

	    if(!n){
	    	btns.remove.disable();
				btns.edit.disable();
	      return;
			} else {
				btns.remove.enable();
				btns.edit.enable();
				return;
	    }
		});
		
		grid.getBottomToolbar().on('render', function(){ 	grid.getBottomToolbar().loading.hide(); });

		function add(){
			window.location = 'new'
		}

		function edit(){
			window.location = selections.getSelected().id+'/edit'
		}

		function remove(){
			Ext.Msg.confirm('Are you sure?', 'Do you want permanently '+selections.getCount()+' element/s?', function(btn, text){
				if (btn == 'yes'){
					selections.each(function(r){
						Lipsiadmin.app.mask('Sending data to server...');
						Ext.Ajax.request({
							url: r.id,
							method: 'DELETE',
							success: function(result, request){
								Lipsiadmin.app.unmask();
								var resultValue = Ext.decode(result.responseText); 
								if (resultValue.success == true){
									ds.remove(r);
								} else { 
						    	Ext.MessageBox.alert('Warning', resultValue.msg);
									return;
								}
							},								
							failure: function(result, request) {
								Lipsiadmin.app.unmask();
								Ext.Msg.alert('Warning', 'There is a problem in the code. Contact the support.');
							}
						});
					})
				}
			});
		}
		
		ds.load(Ext.util.Pagination);
		
		Lipsiadmin.app.addItem(grid);
	});
	
	Lipsiadmin.app.mask("Retrive data from server");
	js.load();
});
</script>
<% end %>